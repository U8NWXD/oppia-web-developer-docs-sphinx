<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Debugging stories &mdash; Oppia Web Contributor Documentation  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Launching new features" href="Launching-new-features.html" />
    <link rel="prev" title="Debug frontend tests" href="Debug-frontend-tests.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Oppia Web Contributor Documentation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Core documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Oppia%27s-Mission.html">Oppia’s Mission</a></li>
<li class="toctree-l1"><a class="reference internal" href="Oppia%27s-Mission.html#vision">Vision</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/oppia/oppia/blob/develop/.github/CODE_OF_CONDUCT.md">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="get-involved.html">Get Involved</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developing Oppia</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Frequently-Asked-Questions.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="Installing-Oppia.html">Installing Oppia</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tips-for-common-IDEs.html">Tips for common IDEs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Make-a-pull-request.html">Make a pull request</a></li>
<li class="toctree-l1"><a class="reference internal" href="Pull-requests-at-Oppia.html">Pull requests at Oppia</a></li>
<li class="toctree-l1"><a class="reference internal" href="Get-help.html">Get help</a></li>
<li class="toctree-l1"><a class="reference internal" href="Learning-Resources.html">Learning resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="Git-cheat-sheet.html">Git cheat sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="get-started.html">Get started with the code base</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="coding-guidelines.html">Coding guidelines</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Coding-style-guide.html">Coding style guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="The-File-Naming-Convention-and-Directory-Structure.html">Guidelines for creating new files</a></li>
<li class="toctree-l2"><a class="reference internal" href="Adding-new-page.html">How to add a new page</a></li>
<li class="toctree-l2"><a class="reference internal" href="Guide-on-defining-types.html">How to write type definitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="Writing-design-docs.html">Writing design docs</a></li>
<li class="toctree-l2"><a class="reference internal" href="Revert-and-Regression-Policy.html">Revert and regression policy</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="debugging.html">Debugging</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="If-your-build-fails.html">If your build fails</a></li>
<li class="toctree-l3"><a class="reference internal" href="If-your-presubmit-check-fails.html">If your presubmit check fails</a></li>
<li class="toctree-l3"><a class="reference internal" href="Interpreting-CircleCI-Results.html">Interpreting CircleCI Results</a></li>
<li class="toctree-l3"><a class="reference internal" href="Debugging-Docs.html">Debugging docs</a></li>
<li class="toctree-l3"><a class="reference internal" href="Debug-end-to-end-tests.html">Debug end to end tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="Debug-backend-tests.html">Debug backend tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="Debug-frontend-tests.html">Debug frontend tests</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Debugging stories</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#google-app-engine-sdk-upgrade">Google App Engine SDK Upgrade</a></li>
<li class="toctree-l4"><a class="reference internal" href="#speeding-up-frontend-tests">Speeding Up Frontend Tests</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Launching-new-features.html">Launching new features</a></li>
<li class="toctree-l2"><a class="reference internal" href="Developing-new-features-with-feature-gating.html">Feature Gating</a></li>
<li class="toctree-l2"><a class="reference internal" href="lint.html">Lint Checks</a></li>
<li class="toctree-l2"><a class="reference internal" href="Oppia%27s-code-owners-and-checks-to-be-carried-out-by-developers.html">Oppia’s code owners and checks to be carried out by developers</a></li>
<li class="toctree-l2"><a class="reference internal" href="Oppia%27s-code-owners-and-checks-to-be-carried-out-by-developers.html#temporary-codeowner-transfer-process">Temporary codeowner transfer process</a></li>
<li class="toctree-l2"><a class="reference internal" href="Privacy-aware-programming.html">Privacy aware programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="Privacy-aware-programming.html#basics">Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="Privacy-aware-programming.html#design-stage">Design stage</a></li>
<li class="toctree-l2"><a class="reference internal" href="Privacy-aware-programming.html#implementation-stage">Implementation stage</a></li>
<li class="toctree-l2"><a class="reference internal" href="Backend-Type-Annotations.html">Backend type annotations</a></li>
<li class="toctree-l2"><a class="reference internal" href="Bytes-and-string-handling-in-Python-3.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="Bytes-and-string-handling-in-Python-3.html#rules-for-handling-strings-and-bytes">Rules for handling strings and bytes</a></li>
<li class="toctree-l2"><a class="reference internal" href="Guidelines-for-Developers-with-Write-Access-to-oppia-oppia.html">Guidelines for developers with write access to Oppia Oppia</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="release.html">Release process</a></li>
<li class="toctree-l1"><a class="reference internal" href="Events-Team.html">Oppia Events team</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Oppiabot.html">Oppiabot</a></li>
<li class="toctree-l1"><a class="reference internal" href="frontend-reference.html">Frontend</a></li>
<li class="toctree-l1"><a class="reference internal" href="backend-reference.html">Backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="Adding-new-translations-for-i18n.html">Adding new translations for i18n</a></li>
<li class="toctree-l1"><a class="reference internal" href="How-to-develop-for-i18n.html">How to develop for i18n</a></li>
<li class="toctree-l1"><a class="reference internal" href="Webpack.html">Webpack</a></li>
<li class="toctree-l1"><a class="reference internal" href="extension-reference.html">Extension frameworks</a></li>
<li class="toctree-l1"><a class="reference internal" href="Advice-on-creating-explorations.html">Advice on creating explorations</a></li>
<li class="toctree-l1"><a class="reference internal" href="Oppia-ml-Extension.html">Oppia-ml Extension</a></li>
<li class="toctree-l1"><a class="reference internal" href="Mobile-development.html">Mobile development</a></li>
<li class="toctree-l1"><a class="reference internal" href="Mobile-device-testing.html">Mobile device testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="Performance-Testing.html">Performance testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="Build-process.html">Build process</a></li>
<li class="toctree-l1"><a class="reference internal" href="Team-Structure.html">Team structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="playbooks.html">Playbooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="past-events.html">Past Events</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Oppia Web Contributor Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="coding-guidelines.html">Coding guidelines</a> &raquo;</li>
          <li><a href="debugging.html">Debugging</a> &raquo;</li>
      <li>Debugging stories</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/Debugging-Stories.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="debugging-stories">
<h1>Debugging stories<a class="headerlink" href="#debugging-stories" title="Permalink to this headline"></a></h1>
<p>Sometimes, things go wrong while programming, and the reason for that is not obvious! In order to figure out what’s happening, you will need to <strong>debug</strong> the code. This is an important skill to learn, but not an easy one to teach. On this page, we present a few examples of “debugging stories” from team members, so that you can see how other people approach tricky problems in the codebase.</p>
<p><em>Oppia contributors: If you have other cool debugging stories to share, please feel free to add them below!</em></p>
<section id="google-app-engine-sdk-upgrade">
<h2>Google App Engine SDK Upgrade<a class="headerlink" href="#google-app-engine-sdk-upgrade" title="Permalink to this headline"></a></h2>
<p><em>Contributed by Kevin Zhang</em> (<strong>&#64;kevjumba</strong>)</p>
<p>The context for this story arose when I was migrating our memcache usage to MemoryStore as part of a larger migration to the Python 3 version of App Engine. Before the migration, we were using a deprecated version of the Google App Engine (GAE) SDK, which resided in its standalone package: ‘google_appengine_1.9.67’. Separately, we had installed the Google Cloud SDK in a different folder, so that we could use its ‘gcloud’ command line interface (CLI) utility.</p>
<p>However, times have changed, and Google no longer supports a standalone GAE package. Instead, the newest version of the GAE SDK is packaged within the latest version of the Google Cloud SDK. Moreover, I needed a ‘VPC access connector’ for the migration, and only the latest version of the GAE SDK included that.</p>
<p>So, I needed to update the way we use and install the GAE SDK by migrating away from the standalone package, and instead use the newest version of the Google Cloud SDK for all GAE-related operations. Unfortunately, during this upgrade, I encountered multiple errors related to incompatibilities with our old usage, detailed below. But first, some background:</p>
<section id="background">
<h3>Background<a class="headerlink" href="#background" title="Permalink to this headline"></a></h3>
<ol class="simple">
<li><p>The top level ‘Google Cloud SDK’ folder will be referred to as the <strong>root</strong> folder.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">dev_appserver.py</span></code> script is a special python script provided by the Google App Engine package that allows us to start our own local development server. In the standalone Google App Engine package, <code class="docutils literal notranslate"><span class="pre">dev_appserver.py</span></code> resided in the top level directory. However, the Google Cloud SDK added a new version of the <code class="docutils literal notranslate"><span class="pre">dev_appserver.py</span></code> file in a bin folder under the <strong>root</strong> folder, namely <code class="docutils literal notranslate"><span class="pre">root/bin/</span></code>.</p></li>
<li><p>Oppia uses CircleCI. This software allocates certain instances of a Ubuntu VM to us so we can run tests on their Ubuntu instances whenever a PR is updated or created.</p></li>
</ol>
</section>
<section id="migration-process">
<h3>Migration Process<a class="headerlink" href="#migration-process" title="Permalink to this headline"></a></h3>
<ol class="simple">
<li><p>I first replaced all the old usages of ‘dev_appserver.py’ with usage of the newer Google Cloud SDK version.</p></li>
<li><p>The normal development server started fine. I tested some functionality on the development server and nothing seemed out of the ordinary. However, after I submitted a PR, the CircleCI e2e tests started failing. When the dev app server tried to start on the CircleCI build, the build errored out with the message: “Permission Denied”. Unfortunately, this error wasn’t reproducible on my local machine and there was no indication of why the Circle CI Ubuntu instance would be different than my own UNIX instance.</p>
<ul class="simple">
<li><p><strong>Initial Local Debugging:</strong> After perusing the stack-trace, I discovered a reference to a subprocess call nested within the Google App Engine source code. The call executed a command <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-c</span> <span class="pre">import</span> <span class="pre">grpc</span></code>. Basically, this command tries to import the grpc library – a library included in the Google Cloud SDK folder – through the command line.</p>
<ul>
<li><p>Furthermore, while reading the App Engine source code, I realized that the <code class="docutils literal notranslate"><span class="pre">dev_appserver.py</span></code> script in the <strong>root</strong> folder actually points to a <code class="docutils literal notranslate"><span class="pre">dev_appserver.py</span></code> script that was nested further within the Cloud SDK folder. At the time, I didn’t realize the importance of this fact.</p></li>
</ul>
</li>
<li><p><strong>Circle CI Instance Debugging:</strong> In an attempt to fix the ‘Permission Denied’ bug, I checked out another branch on top of mine so that I could perform quick tests in the CircleCI environment by pushing new commits. To help this move faster, I temporarily deleted all the ‘.github/workflows’ yaml configuration files, except for the ‘.circleci/config.yml’ file that controls the tests that are run on the CircleCI instance. I edited this file so that it would only run a simple test, to enable me to debug this error using quick iterations on the CircleCI build.</p>
<ul>
<li><p>First, I tried running <code class="docutils literal notranslate"><span class="pre">chmod</span> <span class="pre">-R</span> <span class="pre">777</span></code> on the entire directory, but this didn’t change the error message.</p></li>
<li><p>Next, I added a <code class="docutils literal notranslate"><span class="pre">subprocess</span></code> command to print out the relevant file permissions right before the development server is started, and compared this output to the permissions on my own computer. Python’s default import functionality looks for the <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file in a directory, and then checks for the specific folder to import (in this case, <code class="docutils literal notranslate"><span class="pre">grpc</span></code>). Unfortunately, the permissions on the CI instance for those specific folders/files exactly matched the ones on my local machine, which was enough evidence to confirm that file permissions weren’t the issue.</p></li>
<li><p>Since the permissions seemed to match, I added <code class="docutils literal notranslate"><span class="pre">sudo</span></code> to the command to start the dev server, as a test to see whether using a root user would help. This did not change the error, therefore ruling out the possibility of a user-access bug.</p></li>
<li><p>I decided that my debugging cycles were too slow at this point, so I researched how to ssh into the CI instance for more efficient debugging. The steps to do this are as follows:
1. Rerun a job with the button “Rerun job with SSH” on the top-right of the circle CI console.
2. After the job finishes, expand the tab at the bottom labeled, “Enable SSH”. It should provide you with details to log in to the CircleCI instance’s terminal.</p></li>
<li><p>I logged into the SSH instance and tried a variety of tests.</p>
<ul>
<li><p>I tried importing ‘grpc’ from the command line which resulted in the error: <code class="docutils literal notranslate"><span class="pre">ImportError:</span> <span class="pre">grpc/_cython/cygrpc.so:</span> <span class="pre">undefined</span> <span class="pre">symbol:</span> <span class="pre">PyUnicodeUCS2_DecodeLatin1</span></code>. This error is due to the fact that the Circle CI instance runs a default Python version that uses 4-character unicode. However, the included version of <code class="docutils literal notranslate"><span class="pre">grpc</span></code> was compiled using a 2-character unicode format, so the compilations don’t match. I did research on whether it was possible to build CircleCI’s python docker image with a different unicode setting, but there were no known solutions to this issue.</p></li>
<li><p>I tried resetting the entire Google App Engine directory with ‘chmod -R 777’, just to confirm that user privileges were the issue (they were not).</p></li>
<li><p>I tried running the <code class="docutils literal notranslate"><span class="pre">dev_appserver.py</span></code> script from the terminal and got the same error.</p></li>
<li><p>Neither of these possible solutions worked, so I postulated that it’s possible we weren’t supposed to actually run the <code class="docutils literal notranslate"><span class="pre">dev_appserver.py</span></code> from the <strong>root</strong> directory in the way that we did.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Arriving at the Solution:</strong> I remembered, from earlier, that the <strong>root</strong> folder ‘dev_appserver.py’ script actually calls a nested <code class="docutils literal notranslate"><span class="pre">dev_appserver.py</span></code> script, so I went to investigate what exactly that script did. From reading the contents, it seemed like this script provided most of the functionality that our app needed. So, I changed all of the paths to point the nested python script instead, and tried running the e2e tests. Thankfully, it finally started the development server, and the tests started running and passing!</p></li>
</ul>
</li>
</ol>
</section>
</section>
<section id="speeding-up-frontend-tests">
<h2>Speeding Up Frontend Tests<a class="headerlink" href="#speeding-up-frontend-tests" title="Permalink to this headline"></a></h2>
<p><em>Contributed by Kevin Thomas</em> (<strong>&#64;kevintab95</strong>)</p>
<p>Around the second week of March 2020, Oppia devs reported that the frontend tests were taking too long to complete execution. The issue was investigated and fixed in <a class="reference external" href="https://github.com/oppia/oppia/pull/8864">PR #8864</a>. This writeup details the process behind the fix.</p>
<p>Initial inspection of the console output revealed that the “build” part of the test script took a considerable amount of time to complete, compared to the execution of the tests. However, the build process is expected to take time because all the test files need to be bundled into a large file, and the webpack build process is known to be slow. So in order to speed up the script, I figured that I would need to speed up the actual tests.</p>
<p>The output provided in the terminal seemed insufficient for debugging. So, to get a more verbose output and to be able to use more advanced tools, I changed the following settings in karma.conf.ts:</p>
<p align="center"><img width="600px" src="https://user-images.githubusercontent.com/11008603/91498050-b710c480-e8dc-11ea-87e9-74c95978c2ed.png" /></p>
<p>I also set “browser” to Chrome instead of headless Chrome, and “singleRun” to false so that the browser remains open after the tests complete execution. Running the tests on Chrome browser would allow me to leverage the built-in devtools for debugging purposes.</p>
<p>Running the test with these settings opened up the Chrome browser:</p>
<p align="center"><img width="600px" src="https://user-images.githubusercontent.com/11008603/91498453-68175f00-e8dd-11ea-9452-980604768abc.gif" /></p>
<p>To allow debugging, I enabled “DEBUG” mode by clicking on the debug button, as seen in the image above.</p>
<p>This showed that, in the console tab, a significant number of “response errors” were logged.</p>
<p align="center"><img width="400px" src="https://user-images.githubusercontent.com/11008603/91498552-92691c80-e8dd-11ea-8217-94765c400906.png" /></p>
<p>These errors occur because spec files which mock backend calls may expect resolved/rejected responses. So what could be investigated was to check whether there were any bottlenecks when those errors are logged.</p>
<p>The standard way to identify performance bottlenecks is to use the built-in Javascript Profiler. Once the test started to execute, I fired up devtools and used a JavaScript profiling tool to record a small segment of the test execution (e.g. 10-20 seconds).</p>
<p align="center"><img width="600px" src="https://user-images.githubusercontent.com/11008603/91498651-c6dcd880-e8dd-11ea-929f-2fddcc0963f1.gif" /></p>
<p>I then stopped the recording after 10-20s and exported the result as a JSON file, and stopped the remainder of the test script. I then uploaded the captured JS profile in a new browser instance.</p>
<p align="center"><img width="600px" src="https://user-images.githubusercontent.com/11008603/91498725-ed027880-e8dd-11ea-9484-07ba6dec06c6.gif" /></p>
<p>Searching for “responseError” in the loaded profile showed a large number of results.</p>
<p align="center"><img width="800px" src="https://user-images.githubusercontent.com/11008603/91498828-19b69000-e8de-11ea-85dd-7cffd82ca3a9.png" /></p>
<p>Zooming into a few of the results indicated that the “mapStacktrace” operation was executed for every “responseError” call. Although the operation seemed to take only a short time to execute (~5ms), this seemed like a potential bottleneck because of the frequency of its occurrence, especially when it could be avoided altogether. It is an expensive operation to map the stack trace info of the bundled code to that of the individual files and, since tests are run in DEV mode, this operation seemed unnecessary.</p>
<p align="center"><img width="800px" src="https://user-images.githubusercontent.com/11008603/91498863-2935d900-e8de-11ea-8f2a-308f83024081.png" /></p>
<p>As a fix, I added a check to ensure that the “mapStacktrace” operation only executes if DEV_MODE is false. Subsequent test runs with this fix indicated a significant decrease in the runtime (~by half, from 8m to 4m)!</p>
<p align="center"><img src="https://user-images.githubusercontent.com/11008603/91499014-60a48580-e8de-11ea-89c0-bda7b4e52478.png" /></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Debug-frontend-tests.html" class="btn btn-neutral float-left" title="Debug frontend tests" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Launching-new-features.html" class="btn btn-neutral float-right" title="Launching new features" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, The Oppia Authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>